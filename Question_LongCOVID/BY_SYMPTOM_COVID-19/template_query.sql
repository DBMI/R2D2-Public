/*********************************************************************************************************
Project: R2D2
Question number: 
Question in Text:

Database: SQL Server
Author name: Akarsh	Dsouza
Author GitHub username: AkarshJDsouza
Author email: ajdsouza@usc.edu
Version : 3.1
Invested work hours at initial git commit:
Initial git commit date:
Last modified date: 

Assumptions:
--------------- 

Instructions: 
-------------

Initialize variables: 
		  i) Please change the site number of your site
		 ii) Please change threshold for minimum counts to be displayed in the results. Possible values are 0 or 11.
				Default value is 0 (ie no cell suppression). When value is 11, result cell will display [1-10].
	
Section 1: Create a base cohort

Section 2: Prepare concept sets

Section 3: Design a main body
	
Section 4: Report in a tabular format


Updates in this version:
-------------------------


*************************************************************************************************************/


/*********************** Initialize variables *****************/

declare @sitename varchar(20) = 'Site10';
declare @minAllowedCellCount int = 0;		--Threshold for minimum counts displayed in results. Possible values are 0 or 11

USE OMOP_v5;

/********************************************************/
	

-------- do not update ---------
declare @version numeric(2,1) = 3.1;
declare @queryExecutionDate datetime = (select getdate());
declare @cohortStartDate date = '2020-01-01'
declare @cohortEndDate date = '2021-02-20' -- KP changed '2021-03-18' to '2021-02-20'

/************************************************************************************************************* 
	Section 1: Get COVID hospitalizations using R2D2 concept sets 
**************************************************************************************************************/

if object_id('tempdb.dbo.#covid_positive_dup') is not null drop table #covid_positive_dup  
select * into #covid_positive_dup from R2D2.fn_identify_patients()
if object_id('tempdb.dbo.#covid_positive') is not null drop table #covid_positive
select cp.* , datediff(dd, p.birth_datetime, cp.COHORT_START_DATE)/365.25 AgeAt_PCR_test
into #covid_positive
from (
	select cp1.PERSON_ID, min(COHORT_START_DATE) as COHORT_START_DATE 
	from #covid_positive_dup cp1
	where cp1.COHORT_START_DATE between @cohortStartDate and @cohortEndDate
	group by cp1.PERSON_ID
) cp 
left join omop5.person p on p.person_id = cp.PERSON_ID


--include patients with atleast 1 followup visit (6mo after index date)
delete cp
from #covid_positive cp
left join (
	select distinct cp.PERSON_ID
	from #covid_positive cp 
	join omop5.visit_occurrence vo on cp.PERSON_ID = vo.person_id
	where vo.visit_start_datetime between cp.COHORT_START_DATE and dateadd(mm, 6, cp.COHORT_START_DATE) --atleast 1 followup visit in 6mo post COVID test
	group by cp.PERSON_ID having count(*) >=1
) b on cp.PERSON_ID = b.PERSON_ID
where b.PERSON_ID is null 


drop table if exists #covid_hsp;
create table #covid_hsp (
		visit_occurrence_id bigint 
		, person_id bigint
		, visit_concept_id bigint
		, visit_start_datetime datetime
		, visit_end_datetime datetime
		, discharge_to_concept_id bigint
		, discharge_to_source_value varchar(256)
		, AgeAtVisit int
		, cohort_start_date datetime
		, days_bet_COVID_tst_hosp int
		, death_datetime datetime
		, Hospital_mortality int
		, rownum int
	);

insert into #covid_hsp (visit_occurrence_id, person_id, visit_concept_id, visit_start_datetime, visit_end_datetime
		, discharge_to_concept_id, discharge_to_source_value, AgeAtVisit,  cohort_start_date, days_bet_COVID_tst_hosp 
		, death_datetime, Hospital_mortality, rownum)
exec R2D2.sp_identify_hospitalization_encounters	--- gets COVID hospitalizations

--remove COVID19 hospitalizations outside the cohort start and end dates
delete #covid_hsp 
where visit_start_datetime <@cohortStartDate or visit_start_datetime > @cohortEndDate

/************************************************************************************************************* 
	Section 2: Concept sets specific to question (R2D2 Atlas)
**************************************************************************************************************/
 
drop table if exists #dconcepts;
select 'Myocarditis Pericarditis' as concept_set, concept_id, concept_name into #dconcepts from OMOP_Vocabulary.vocab_51.concept where concept_id in 
(
46273471,46270123,46269742,45766217,43021971,43021340,43021293,43021292,43021291,43021289,43021194,43021186,43021185,43021184,43021183,43021067,43020798,43020652,37311079,37311078,37310287,37109916,37109914,37017108,37016749,36716865,35624116,4337524,4336533,4331309,4326421,4322145,4319127,4314708,4304392,4302770,4299935,4296152,4295270,4291329,4290395,4282614,4279774,4277121,4276025,4275129,4272028,4264740,4264536,4264207,4252587,4246167,4245386,4242712,4239311,4238669,4237738,4235735,4231274,4230199,4229749,4227053,4224425,4219260,4218568,4217075,4214249,4205441,4204985,4204707,4204533,4203625,4196638,4196524,4195405,4192358,4190901,4189533,4189352,4187049,4186928,4185852,4183718,4181182,4178425,4175152,4170217,4165259,4164723,4155496,4155486,4147350,4144887,4143969,4143776,4141815,4138837,4124694,4121477,4121476,4121473,4119596,4119595,4119594,4119591,4119590,4111541,4111403,4111400,4111399,4111093,4111091,4111090,4111089,4111088,4111081,4111080,4108949,4108812,4108810,4108800,4108799,4108798,4108685,4108229,4108227,4108226,4108223,4104253,4103516,4103288,4101469,4101090,4097815,4093494,4083887,4072086,4071283,4070323,4069712,4067471,4061917,4056882,4056843,4053008,4048055,4035033,4031469,4030730,4006977,4006483,764141,761739,444083,443778,442569,442112,321586,321578,321307,320745,320743,320127,320116,320025,319728,319720,317307,317301,315293,314383,312928,312653,312543,312334
);
--select * from #dconcepts

insert into #dconcepts
select 'Insomnia' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in 
(
44784625,43020938,43020415,42538607,37397765,37395584,37117120,37110488,37016173,4283230,4282607,4268443,4243368,4228217,4215402,4182361,4138617,4102985,4093843,4087476,4087475,4012514,763092,440082,439013,436962,436681,434918,434172
);

insert into #dconcepts
select 'Dizziness Vertigo' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in 
(
45769954,44806935,43531621,43530752,43530629,43021417,42709963,42709962,42539141,42536612,42535684,36715393,4337455,4335746,4335745,4324948,4319017,4287867,4286178,4269196,4250121,4224944,4223938,4219198,4218878,4201421,4198449,4194391,4180463,4172609,4158795,4111253,4097171,4079560,4077912,4034840,4012877,4012876,4012875,4012874,4012872,4012871,4012870,4012691,4012422,4012421,4012420,4012419,4012243,4011942,4011940,4011939,4011938,4011937,4011336,4011335,4011334,4011333,764848,764819,444297,440426,439383,433316,381035,81878
);

insert into #dconcepts
select 'Fever' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in 
(
45767113,43530637,37017455,36716728,36714255,36712667,4328373,4320537,4299794,4274502,4268846,4260205,4239624,4226022,4170737,4164645,4164378,4158332,4158331,4158330,4158329,4154923,4152360,4152340,4152339,4143214,4127282,4094003,4094001,4094000,4093998,4093996,4093995,4087629,4087628,4087627,4087017,4087016,4086668,4086667,4086666,4086665,4086664,4086663,4048098,4040479,4040273,4040272,4040270,4040110,4040107,4039979,4039799,4039798,4039796,4039793,4009878,443908,440637,437663,136030
) ;

insert into #dconcepts
select 'Myositis Mylgia' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in 
(
46284893,45773379,45765443,45757641,44811611,44783579,43531620,40483721,37118025,37016663,36713056,36684460,36684438,4347181,4345571,4344370,4344054,4319607,4319324,4318813,4318397,4316217,4312593,4298555,4296601,4270201,4250329,4216406,4204396,4186213,4184119,4184118,4182034,4179293,4153651,4150753,4150130,4147045,4133641,4133038,4126064,4125939,4125938,4125937,4121935,4121934,4121598,4121597,4080995,4077000,4031115,4000979,765215,761310,761309,761308,761307,761306,442752,442315,433774,258828,80800,80182,76508,75048,73001
) ;

insert into #dconcepts
select 'Mental Health' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in 
(
46287147,46286940,46284261,46284259,46284258,45757569,45757213,45757197,45757196,45757195,45757163,45757162,45757095,44813509,44813499,44806193,44805669,44805668,44805667,44805553,44805552,44805550,44805549,44805548,44805547,44805545,44805543,44805542,44805540,44804961,44792465,44790897,44784632,44784629,44784619,44784535,44784531,44784526,44783184,44782943,44782938,44782937,44782932,44782771,44782720,44782518,44782433,43531624,43022060,43021849,43021847,43020483,43020451,43020441,42872722,42872413,42872412,42872411,42539615,42539545,42539544,42539371,42539356,42539152,42539146,42539145,42538968,42538745,42538739,42538738,42538737,42538736,42538735,42538734,42538733,42538732,42538731,42538605,42538604,42538603,42538602,42538601,42538600,42538599,42538598,42538597,42538596,42538595,42538593,42538592,42538591,42538590,42538589,42538588,42538587,42538585,42538584,42537777,42537776,42537691,42537140,42537139,42537138,42536755,42536612,42536611,42536610,42536609,42536608,42536607,42535649,42534817,40486886,40486521,40484109,40483671,40482661,40481798,40480879,40480423,40480415,37396201,37395653,37312578,37312550,37312479,37311991,37311990,37311989,37311988,37311987,37311986,37311915,37311515,37309777,37309775,37309680,37209504,37209503,37204554,37204504,37204238,37203915,37119236,37119149,37119148,37119146,37117218,37117214,37117212,37117211,37117178,37117177,37117155,37117049,37111697,37110547,37110546,37110498,37110497,37110496,37110495,37110494,37110491,37110473,37110472,37110466,37110465,37110464,37110463,37110462,37110453,37110452,37110448,37110443,37110440,37110439,37110438,37110437,37110433,37110432,37110431,37110430,37110429,37110428,37110427,37110426,37110425,37110408,37109954,37109952,37109951,37109950,37109942,37109941,37109940,37109939,37109938,37109937,37109206,37109054,37109053,37109052,37108954,37018689,37018656,37016741,37016719,37016718,37016268,36717389,36717092,36715000,36714999,36714998,36714997,36714473,36714389,36713698,36712668,36684319,36676588,36674915,35624748,35624747,35624745,35624744,35624743,35624222,35623289,35622934,35615155,35615154,35615153,35615152,35615151,35610113,35610112,35610111,35610110,35610109,35610108,35610097,35610094,35609907,35609906,35609904,35609903,35609901,35609845,35609844,35609843,35609842,35609824,4338812,4338662,4338035,4338034,4338031,4338029,4338020,4338019,4338018,4336980,4336957,4336405,4335170,4335169,4335168,4335161,4335160,4333687,4333681,4333680,4333679,4333678,4333677,4333670,4333667,4332999,4332998,4332994,4332878,4330846,4329560,4329036,4328217,4327669,4327348,4327337,4325875,4324959,4324945,4324406,4323418,4322477,4321835,4321694,4314692,4312736,4310821,4310121,4308932,4308866,4307956,4307951,4307804,4307791,4307664,4307518,4307111,4306640,4305966,4305083,4305082,4304140,4304014,4304013,4304010,4302523,4301106,4300755,4299970,4299785,4299737,4298550,4298317,4297987,4297828,4296535,4295956,4294414,4289751,4288013,4288011,4287544,4287238,4286201,4283219,4282316,4282096,4280361,4278987,4278373,4278360,4277739,4276670,4274957,4273699,4272468,4272328,4272313,4271457,4271053,4270907,4270890,4269493,4269143,4268775,4263770,4263748,4263364,4262415,4262272,4262111,4257045,4253782,4253057,4252417,4252409,4251178,4250625,4250023,4247433,4246992,4246498,4245974,4244690,4244078,4244059,4243822,4243308,4243153,4242733,4242704,4242095,4241158,4239471,4239453,4238682,4237734,4236021,4233990,4233250,4232639,4230656,4228802,4228218,4226155,4225906,4224940,4224639,4223090,4221253,4220989,4220618,4220617,4220023,4219627,4219582,4219539,4219044,4218985,4218624,4217940,4217601,4216772,4216701,4215917,4213979,4211231,4210024,4206779,4205471,4205119,4205002,4204708,4204688,4203503,4203449,4202389,4201739,4200385,4199892,4199244,4198826,4197669,4197222,4196373,4195680,4195572,4195158,4194671,4194222,4192865,4189538,4185096,4184004,4182998,4182847,4182683,4182539,4182119,4181807,4179767,4178928,4178114,4177651,4177015,4176286,4176002,4175779,4175329,4174987,4174677,4172156,4171336,4170133,4168861,4168858,4168298,4166701,4165890,4165509,4161200,4159643,4155798,4155208,4154805,4154391,4154309,4154283,4153292,4152971,4152371,4152280,4152048,4151170,4150985,4150950,4150799,4150047,4150015,4149321,4149320,4148934,4148842,4148630,4148140,4147991,4147972,4147466,4147345,4146867,4146712,4146660,4146608,4145216,4145071,4144519,4144233,4144146,4143602,4142811,4141603,4141454,4141292,4140988,4138454,4138168,4137120,4136662,4136518,4135202,4134596,4133495,4133191,4133073,4132780,4132144,4131027,4129843,4129842,4129184,4121141,4117108,4114950,4109930,4107538,4107375,4105930,4105330,4105192,4103853,4103574,4103571,4103570,4103567,4103430,4103278,4103277,4103276,4103275,4103126,4103124,4102973,4102971,4102970,4102968,4102966,4102965,4102936,4102802,4102670,4102660,4102603,4101149,4101143,4101142,4101139,4100536,4100533,4100532,4100382,4100366,4100365,4100247,4100100,4099958,4099957,4099956,4099954,4099942,4098322,4098320,4098316,4098315,4098310,4098308,4098302,4098166,4096229,4094507,4094358,4093584,4092239,4092153,4092152,4091701,4091700,4091687,4088141,4086118,4085666,4085662,4083876,4082000,4081257,4078451,4077976,4077963,4077577,4073401,4071442,4067987,4067409,4066023,4060424,4057246,4057218,4056690,4054913,4051448,4050327,4049623,4049367,4047760,4046101,4045263,4043379,4039212,4038252,4037669,4037302,4034842,4033940,4033939,4033937,4033936,4033509,4033390,4033050,4033049,4033048,4033047,4033046,4031928,4031328,4031212,4030856,4030739,4030432,4030431,4030102,4029464,4029005,4028783,4028677,4028027,4026127,4025677,4024443,4012869,4009651,4009648,4009184,4008568,4008566,4006459,4003829,4002897,4001733,4000165,762060,761947,761111,444434,444396,444259,444243,444100,444079,444038,443930,443906,443797,443559,443414,443237,442920,442919,442918,442917,442600,442570,442306,442077,441836,441835,441834,441828,441545,441543,441540,441538,441534,440993,440989,440987,440983,440980,440698,440696,440690,440686,440684,440383,440374,440373,440368,440083,440079,440078,440067,439786,439785,439781,439707,439691,439437,439275,439274,439273,439272,439262,439261,439259,439256,439255,439254,439253,439251,439250,439249,439248,439246,439245,439005,439004,439001,438998,438737,438729,438727,438724,438406,438405,438129,438119,437841,437831,437549,437537,437536,437534,437532,437529,437528,437522,437258,437250,437249,437244,437243,436953,436952,436947,436944,436677,436676,436673,436665,436390,436386,436385,436384,436086,436079,436076,436075,436074,436073,436072,436071,436067,435799,435784,435783,435782,435532,435520,435237,435236,435230,435226,435225,435220,435219,435218,435217,434920,434911,434901,434900,434889,434628,434625,434613,434332,434321,434318,434017,433996,433992,433991,433990,433751,433743,433734,433454,433450,433443,433442,433440,433178,433177,432883,432876,432866,432865,432864,432600,432598,432597,432590,432299,432290,432285,381537,380986,377788,375229,375221,374014,373176,373172,372599
)
insert into #dconcepts
select 'Cough' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in 
(
4128691,4023177,4137418,433596,443363,4116989,4077128,4166934,4265470,4283806,4266667,4048759,44789593,4082813,4195384,4086814,4088600,4158493,4273031,4273030,4089232,254761,4188217,4323688,3199166,4077210,4000163,4048218,4009383,4094147,4048098,4080583,4126096,44808882,4199298,44806100,4128692,4144508,4116781,4088601,4122567,4117283,4125451,4116782,4038519,4266704,4103332,4058584,4008103,4115389,4275649,4269128,4278454,4183576,4117288,4287098,4174286,4174289,4243802,3190520,4270340,4087181,4059020,4276051,4077372,4231569,35626061,4269800,4060313,4088599,4203121,4090569,44808883,4182587,4109381,4103346,4009942,40482863,4102774,4060224,4060051,4059017,4115388,4172486,4166935,44789249,4167374,4086357,4088598,4263877,4271318,4155913,4155914,4154933,4267352,4055980,4057611,4043777,4148736,3191604,4059373,4056411,4057610,4077373,4057608,4057607,4057609,4089228,42538317,4057016,4057015,4055979,4057613,4082168,4089229,4151543,4174287,4103347,4080153,4174288,4086815,4087178,4021673,4144507,4196430,4274411,4116793,4323492,4080265
)
insert into #dconcepts
select 'Nausa Vomiting Diarrhea' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in 
(
45766285,45763575,45757468,45757414,44806510,44806407,44783646,42539466,42539349,42535473,37396461,37206122,37116957,36717214,36715842,36714681,36676635,35625971,35623148,4342900,4341787,4341786,4341645,4341247,4340522,4340521,4323686,4320650,4318833,4318832,4318116,4312889,4312477,4307943,4302676,4299836,4274327,4274029,4261727,4249551,4247894,4246979,4242528,4222657,4221087,4220072,4216862,4204219,4204041,4199931,4193870,4188221,4181455,4179793,4174046,4173173,4170402,4170302,4166768,4162530,4153574,4152166,4145808,4145805,4143378,4135220,4134607,4121590,4115563,4105136,4104544,4103552,4100710,4096857,4093451,4091519,4086964,4086763,4085622,4083547,4077591,4077584,4077500,4069683,4056364,4048884,4048601,4032472,4031502,4001337,441546,441408,440785,201780,198337,197484,196523,31967,27674,27321,26727,22666
)
insert into #dconcepts
select 'Arthalgias' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in 
(
45770017,45766457,45757286,42537217,42537212,42535062,37209669,37204166,37117142,37108781,37108780,37108779,37108778,37017182,36712824,36687104,36687071,36686956,36686549,36686548,36685039,36685038,36684444,36676844,36676843,36676231,35611580,35610601,35610134,4345337,4335677,4308649,4198794,4198667,4188350,4185817,4185801,4185666,4185665,4185354,4185205,4185204,4185184,4185183,4185181,4184873,4184729,4184557,4183639,4183373,4182661,4182025,4180973,4180464,4172519,4170554,4150762,4150761,4150128,4150062,4149914,4146939,4146938,4117901,4117899,4117729,4117727,4117726,4116283,4116169,4116168,4116167,4116166,4116165,4116164,4115369,4115368,4115367,4115366,4104479,4103634,4103026,4102558,4102557,4102422,4102267,4101654,4101520,4101378,4100451,4100309,4083770,4079724,4063955,4034033,4004996,765422,765384,765271,765269,765249,765204,765109,763930,762297,762289,762288,761706,761705,761704,761703,761702,761652,761651,760921,760920,760919,760918,760915,760914,760897,760896,759910,759906,759905,759897,759896,79106,78517,78516,78508,78234,78232,77074,73231
)
insert into #dconcepts
select 'Malaise -Fatigue' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in (
45553741,45534458,45602032,1572255,45573032,45582718,1572256,1427711,1427710,1410843,44828146,44829293,44823445,44823473,42497014,45615297,45617037,3074311,3135073,3139188,3141968,3142026,3142369,3143883,3144202,3146371,3146507,3151402,3172766,3229948,3238838,3258651,3266617,3273005,3283667,3287817,3327058,3334534,3339745,3350143,3370653,3372110,3392605,3397636,3400957,3412804,3420248,3057687,3078650,3084756,3085115,3091284,3091286,3091287,3091289,3105428,3109609,3109620,3123043,3123251,45524713,45525703,45525341,45528375,45531370,45526417,45525339,45531372,45531374,45532419,45524714,45443858,45444906,45446529,45453869,45453870,45456613,45457249,45459954,45466756,45477423,45484078,45485120,45486787,45488447,45491729,45518337,45493396,45521607,45497290,45513348,45515012,45511614,45504959,45503934,45495007,45478465,45480798,45420273,45421796,45430052,45443238,40481844,437113,439926,765190,4059010,4060217,4074624,4086973,4093848,4147184,4149857,4152509,4158498,4161600,4167240,4198140,4223659,4272240,36686942,37017316,40267298,40303775,40303779,40303781,40303808,40322782,40325099,40325103,40325134,40348671,40351555,40351907,40354346,40390064,40391099,40417207,40448447,432738,40502727,40506944,40547299,44793521,44793522,44793523,3519112,3201572,3201296,3144125,3143844,3131465,3130861,3130858,3130857,3130856,3108483,3108253,3082266,3074305,40318810,40303776,4158183,44802677,4048774,4048773,4048772,4048775,44802674,44802673,44802672,44802421,44802417,44800199,44797749,40402990,40385132,40321411,40318814,40318812,40318811
)
insert into #dconcepts
select 'Headache' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in (
46270383,46270382,45766090,44790934,44783586,44782806,44782681,42539583,42538612,42538611,40483832,40482953,37110728,37016725,37016721,36716800,4315023,4309592,4271776,4212985,4195951,4193674,4183441,4172302,4170790,4170789,4158490,4149969,4147325,4140381,4115407,4103477,4061404,4044237,4038026,4038025,4037891,4037300,4036953,4036625,4036624,4036622,4030433,4028205,4012515,4012241,4012240,4012239,4011768,4011530,763746,762083,378253,377546,376104,374342,373463,372313
)
insert into #dconcepts
select 'Memorey Attention' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in (
45890915,45767114,45765900,45765899,45595932,45553736,45539344,44837454,44832709,44828985,44823476,44813139,44810571,44810569,44802689,44788981,44784643,44782727,44782726,44782725,44782432,42538566,42537141,42537139,40643427,40637025,40629685,40572565,40572164,40572158,40572112,40572107,40562773,40557775,40546686,40546678,40545778,40545771,40449573,40392746,40386916,40357200,40332778,40332775,40326369,40322273,40318822,40305057,40301718,40301716,40301713,37309663,37309662,37309661,37309660,37117145,37110498,37109222,37016192,36687122,35211349,35211348,35211347,35207397,4336523,4328349,4318665,4314615,4304008,4296610,4264770,4264146,4243064,4229448,4206332,4198081,4193675,4173661,4171718,4166262,4162498,4152488,4145069,4138824,4132117,4101994,4099961,4096717,4096147,4092086,4085655,4085043,4084562,4083456,4076655,4076654,4074319,4071219,4049065,4039106,4038788,4036509,4022572,4012209,4009705,4005009,1572241,761978,443432,439795,439147,437306
)
insert into #dconcepts
select 'Taste Smell' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in (
46270715,44782449,43530714,4291039,4286418,4282137,4266190,4238383,4229142,4224339,4222599,4187519,4168062,4145586,4049347,4049164,4043565,4029012,4008893
)
insert into #dconcepts
select 'Hair Loss' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in (
42539149,36716819,4300916,4253170,4175525,140173
)
insert into #dconcepts
select 'SOB Dyspnea' as concept_set, concept_id, concept_name from OMOP_Vocabulary.vocab_51.concept where concept_id in (
4191650,4221237,4222446,4222444,4223033,4223034,4223035,4223036,4220640,4223037,4223038,4220641,4219740,4059022,4059021,4190875,312437,4212233,4228754,4060052,4065915,4217021,4219335,4248284,4066850,4263848,4091788,35610139,35610140,35610141,35610143,35610142,35610144,4144682,4047610,4178416,4097311,4310059,4193263,4307188,4310172,4192279,44809070,36685567,36685568,36685569,36685570,36685571,4094132,4060439,4060709,315361,4244276,4206307,4148800,4308377,4010972,4253185
)
------------------ Associated Concepts --------------------
insert into #dconcepts
select 'Myocarditis Pericarditis' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept  c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
46273471,46270123,46269742,45766217,43021971,43021340,43021293,43021292,43021291,43021289,43021194,43021186,43021185,43021184,43021183,43021067,43020798,43020652,37311079,37311078,37310287,37109916,37109914,37017108,37016749,36716865,35624116,4337524,4336533,4331309,4326421,4322145,4319127,4314708,4304392,4302770,4299935,4296152,4295270,4291329,4290395,4282614,4279774,4277121,4276025,4275129,4272028,4264740,4264536,4264207,4252587,4246167,4245386, 4242712,4239311,4238669,4237738,4235735,4231274,4230199,4229749,4227053,4224425,4219260,4218568,4217075,4214249,4205441,4204985,4204707,4204533,4203625,4196638,4196524,4195405,4192358,4190901,4189533,4189352,4187049,4186928,4185852,4183718,4181182,4178425,4175152,4170217,4165259,4164723,4155496,4155486,4147350,4144887,4143969,4143776,4141815,4138837,4124694,4121477,4121476,4121473,4119596,4119595,4119594,4119591,4119590,4111541,4111403,4111400,4111399,4111093,4111091,4111090,4111089,4111088,4111081,4111080,4108949,4108812,4108810,4108800,4108799,4108798,4108685,4108229,4108227,4108226,4108223,4104253,4103516,4103288,4101469,4101090,4097815,4093494,4083887,4072086,4071283,4070323,4069712,4067471,4061917,4056882,4056843,4053008,4048055,4035033,4031469,4030730,4006977,4006483,764141,761739,444083,443778,442569,442112,321586,321578,321307,320745,320743,320127,320116,320025,319728,319720,317307,317301,315293,314383,312928,312653,312543,312334
)
insert into #dconcepts
select 'Insomnia' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
44784625,43020938,43020415,42538607,37397765,37395584,37117120,37110488,37016173,4283230,4282607,4268443,4243368,4228217,4215402,4182361,4138617,4102985,4093843,4087476,4087475,4012514,763092,440082,439013,436962,436681,434918,434172
)
insert into #dconcepts
select 'Dizziness Vertigo' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
45769954,44806935,43531621,43530752,43530629,43021417,42709963,42709962,42539141,42536612,42535684,36715393,4337455,4335746,4335745,4324948,4319017,4287867,4286178,4269196,4250121,4224944,4223938,4219198,4218878,4201421,4198449,4194391,4180463,4172609,4158795,4111253,4097171,4079560,4077912,4034840,4012877,4012876,4012875,4012874,4012872,4012871,4012870,4012691,4012422,4012421,4012420,4012419,4012243,4011942,4011940,4011939,4011938,4011937,4011336,4011335,4011334,4011333,764848,764819,444297,440426,439383,433316,381035,81878
)
insert into #dconcepts
select 'Fever' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
45767113,43530637,37017455,36716728,36714255,36712667,4328373,4320537,4299794,4274502,4268846,4260205,4239624,4226022,4170737,4164645,4164378,4158332,4158331,4158330,4158329,4154923,4152360,4152340,4152339,4143214,4127282,4094003,4094001,4094000,4093998,4093996,4093995,4087629,4087628,4087627,4087017,4087016,4086668,4086667,4086666,4086665,4086664,4086663,4048098,4040479,4040273,4040272,4040270,4040110,4040107,4039979,4039799,4039798,4039796,4039793,4009878,443908,440637,437663,136030
)
insert into #dconcepts
select 'Myositis Mylgia' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
46284893,45773379,45765443,45757641,44811611,44783579,43531620,40483721,37118025,37016663,36713056,36684460,36684438,4347181,4345571,4344370,4344054,4319607,4319324,4318813,4318397,4316217,4312593,4298555,4296601,4270201,4250329,4216406,4204396,4186213,4184119,4184118,4182034,4179293,4153651,4150753,4150130,4147045,4133641,4133038,4126064,4125939,4125938,4125937,4121935,4121934,4121598,4121597,4080995,4077000,4031115,4000979,765215,761310,761309,761308,761307,761306,442752,442315,433774,258828,80800,80182,76508,75048,73001
)
insert into #dconcepts
select 'Mental Health' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
46287147,46286940,46284261,46284259,46284258,45757569,45757213,45757197,45757196,45757195,45757163,45757162,45757095,44813509,44813499,44806193,44805669,44805668,44805667,44805553,44805552,44805550,44805549,44805548,44805547,44805545,44805543,44805542,44805540,44804961,44792465,44790897,44784632,44784629,44784619,44784535,44784531,44784526,44783184,44782943,44782938,44782937,44782932,44782771,44782720,44782518,44782433,43531624,43022060,43021849,43021847,43020483,43020451,43020441,42872722,42872413,42872412,42872411,42539615,42539545,42539544,42539371,42539356,42539152,42539146,42539145,42538968,42538745,42538739,42538738,42538737,42538736,42538735,42538734,42538733,42538732,42538731,42538605,42538604,42538603,42538602,42538601,42538600,42538599,42538598,42538597,42538596,42538595,42538593,42538592,42538591,42538590,42538589,42538588,42538587,42538585,42538584,42537777,42537776,42537691,42537140,42537139,42537138,42536755,42536612,42536611,42536610,42536609,42536608,42536607,42535649,42534817,40486886,40486521,40484109,40483671,40482661,40481798,40480879,40480423,40480415,37396201,37395653,37312578,37312550,37312479,37311991,37311990,37311989,37311988,37311987,37311986,37311915,37311515,37309777,37309775,37309680,37209504,37209503,37204554,37204504,37204238,37203915,37119236,37119149,37119148,37119146,37117218,37117214,37117212,37117211,37117178,37117177,37117155,37117049,37111697,37110547,37110546,37110498,37110497,37110496,37110495,37110494,37110491,37110473,37110472,37110466,37110465,37110464,37110463,37110462,37110453,37110452,37110448,37110443,37110440,37110439,37110438,37110437,37110433,37110432,37110431,37110430,37110429,37110428,37110427,37110426,37110425,37110408,37109954,37109952,37109951,37109950,37109942,37109941,37109940,37109939,37109938,37109937,37109206,37109054,37109053,37109052,37108954,37018689,37018656,37016741,37016719,37016718,37016268,36717389,36717092,36715000,36714999,36714998,36714997,36714473,36714389,36713698,36712668,36684319,36676588,36674915,35624748,35624747,35624745,35624744,35624743,35624222,35623289,35622934,35615155,35615154,35615153,35615152,35615151,35610113,35610112,35610111,35610110,35610109,35610108,35610097,35610094,35609907,35609906,35609904,35609903,35609901,35609845,35609844,35609843,35609842,35609824,4338812,4338662,4338035,4338034,4338031,4338029,4338020,4338019,4338018,4336980,4336957,4336405,4335170,4335169,4335168,4335161,4335160,4333687,4333681,4333680,4333679,4333678,4333677,4333670,4333667,4332999,4332998,4332994,4332878,4330846,4329560,4329036,4328217,4327669,4327348,4327337,4325875,4324959,4324945,4324406,4323418,4322477,4321835,4321694,4314692,4312736,4310821,4310121,4308932,4308866,4307956,4307951,4307804,4307791,4307664,4307518,4307111,4306640,4305966,4305083,4305082,4304140,4304014,4304013,4304010,4302523,4301106,4300755,4299970,4299785,4299737,4298550,4298317,4297987,4297828,4296535,4295956,4294414,4289751,4288013,4288011,4287544,4287238,4286201,4283219,4282316,4282096,4280361,4278987,4278373,4278360,4277739,4276670,4274957,4273699,4272468,4272328,4272313,4271457,4271053,4270907,4270890,4269493,4269143,4268775,4263770,4263748,4263364,4262415,4262272,4262111,4257045,4253782,4253057,4252417,4252409,4251178,4250625,4250023,4247433,4246992,4246498,4245974,4244690,4244078,4244059,4243822,4243308,4243153,4242733,4242704,4242095,4241158,4239471,4239453,4238682,4237734,4236021,4233990,4233250,4232639,4230656,4228802,4228218,4226155,4225906,4224940,4224639,4223090,4221253,4220989,4220618,4220617,4220023,4219627,4219582,4219539,4219044,4218985,4218624,4217940,4217601,4216772,4216701,4215917,4213979,4211231,4210024,4206779,4205471,4205119,4205002,4204708,4204688,4203503,4203449,4202389,4201739,4200385,4199892,4199244,4198826,4197669,4197222,4196373,4195680,4195572,4195158,4194671,4194222,4192865,4189538,4185096,4184004,4182998,4182847,4182683,4182539,4182119,4181807,4179767,4178928,4178114,4177651,4177015,4176286,4176002,4175779,4175329,4174987,4174677,4172156,4171336,4170133,4168861,4168858,4168298,4166701,4165890,4165509,4161200,4159643,4155798,4155208,4154805,4154391,4154309,4154283,4153292,4152971,4152371,4152280,4152048,4151170,4150985,4150950,4150799,4150047,4150015,4149321,4149320,4148934,4148842,4148630,4148140,4147991,4147972,4147466,4147345,4146867,4146712,4146660,4146608,4145216,4145071,4144519,4144233,4144146,4143602,4142811,4141603,4141454,4141292,4140988,4138454,4138168,4137120,4136662,4136518,4135202,4134596,4133495,4133191,4133073,4132780,4132144,4131027,4129843,4129842,4129184,4121141,4117108,4114950,4109930,4107538,4107375,4105930,4105330,4105192,4103853,4103574,4103571,4103570,4103567,4103430,4103278,4103277,4103276,4103275,4103126,4103124,4102973,4102971,4102970,4102968,4102966,4102965,4102936,4102802,4102670,4102660,4102603,4101149,4101143,4101142,4101139,4100536,4100533,4100532,4100382,4100366,4100365,4100247,4100100,4099958,4099957,4099956,4099954,4099942,4098322,4098320,4098316,4098315,4098310,4098308,4098302,4098166,4096229,4094507,4094358,4093584,4092239,4092153,4092152,4091701,4091700,4091687,4088141,4086118,4085666,4085662,4083876,4082000,4081257,4078451,4077976,4077963,4077577,4073401,4071442,4067987,4067409,4066023,4060424,4057246,4057218,4056690,4054913,4051448,4050327,4049623,4049367,4047760,4046101,4045263,4043379,4039212,4038252,4037669,4037302,4034842,4033940,4033939,4033937,4033936,4033509,4033390,4033050,4033049,4033048,4033047,4033046,4031928,4031328,4031212,4030856,4030739,4030432,4030431,4030102,4029464,4029005,4028783,4028677,4028027,4026127,4025677,4024443,4012869,4009651,4009648,4009184,4008568,4008566,4006459,4003829,4002897,4001733,4000165,762060,761947,761111,444434,444396,444259,444243,444100,444079,444038,443930,443906,443797,443559,443414,443237,442920,442919,442918,442917,442600,442570,442306,442077,441836,441835,441834,441828,441545,441543,441540,441538,441534,440993,440989,440987,440983,440980,440698,440696,440690,440686,440684,440383,440374,440373,440368,440083,440079,440078,440067,439786,439785,439781,439707,439691,439437,439275,439274,439273,439272,439262,439261,439259,439256,439255,439254,439253,439251,439250,439249,439248,439246,439245,439005,439004,439001,438998,438737,438729,438727,438724,438406,438405,438129,438119,437841,437831,437549,437537,437536,437534,437532,437529,437528,437522,437258,437250,437249,437244,437243,436953,436952,436947,436944,436677,436676,436673,436665,436390,436386,436385,436384,436086,436079,436076,436075,436074,436073,436072,436071,436067,435799,435784,435783,435782,435532,435520,435237,435236,435230,435226,435225,435220,435219,435218,435217,434920,434911,434901,434900,434889,434628,434625,434613,434332,434321,434318,434017,433996,433992,433991,433990,433751,433743,433734,433454,433450,433443,433442,433440,433178,433177,432883,432876,432866,432865,432864,432600,432598,432597,432590,432299,432290,432285,381537,380986,377788,375229,375221,374014,373176,373172,372599
)
insert into #dconcepts
select 'Cough' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
4128691,4023177,4137418,433596,443363,4116989,4077128,4166934,4265470,4283806,4266667,4048759,44789593,4082813,4195384,4086814,4088600,4158493,4273031,4273030,4089232,254761,4188217,4323688,3199166,4077210,4000163,4048218,4009383,4094147,4048098,4080583,4126096,44808882,4199298,44806100,4128692,4144508,4116781,4088601,4122567,4117283,4125451,4116782,4038519,4266704,4103332,4058584,4008103,4115389,4275649,4269128,4278454,4183576,4117288,4287098,4174286,4174289,4243802,3190520,4270340,4087181,4059020,4276051,4077372,4231569,35626061,4269800,4060313,4088599,4203121,4090569,44808883,4182587,4109381,4103346,4009942,40482863,4102774,4060224,4060051,4059017,4115388,4172486,4166935,44789249,4167374,4086357,4088598,4263877,4271318,4155913,4155914,4154933,4267352,4055980,4057611,4043777,4148736,3191604,4059373,4056411,4057610,4077373,4057608,4057607,4057609,4089228,42538317,4057016,4057015,4055979,4057613,4082168,4089229,4151543,4174287,4103347,4080153,4174288,4086815,4087178,4021673,4144507,4196430,4274411,4116793,4323492,4080265
)
insert into #dconcepts
select 'Nausa Vomiting Diarrhea' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
45766285,45763575,45757468,45757414,44806510,44806407,44783646,42539466,42539349,42535473,37396461,37206122,37116957,36717214,36715842,36714681,36676635,35625971,35623148,4342900,4341787,4341786,4341645,4341247,4340522,4340521,4323686,4320650,4318833,4318832,4318116,4312889,4312477,4307943,4302676,4299836,4274327,4274029,4261727,4249551,4247894,4246979,4242528,4222657,4221087,4220072,4216862,4204219,4204041,4199931,4193870,4188221,4181455,4179793,4174046,4173173,4170402,4170302,4166768,4162530,4153574,4152166,4145808,4145805,4143378,4135220,4134607,4121590,4115563,4105136,4104544,4103552,4100710,4096857,4093451,4091519,4086964,4086763,4085622,4083547,4077591,4077584,4077500,4069683,4056364,4048884,4048601,4032472,4031502,4001337,441546,441408,440785,201780,198337,197484,196523,31967,27674,27321,26727,22666
)
insert into #dconcepts
select 'Arthalgias' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
45770017,45766457,45757286,42537217,42537212,42535062,37209669,37204166,37117142,37108781,37108780,37108779,37108778,37017182,36712824,36687104,36687071,36686956,36686549,36686548,36685039,36685038,36684444,36676844,36676843,36676231,35611580,35610601,35610134,4345337,4335677,4308649,4198794,4198667,4188350,4185817,4185801,4185666,4185665,4185354,4185205,4185204,4185184,4185183,4185181,4184873,4184729,4184557,4183639,4183373,4182661,4182025,4180973,4180464,4172519,4170554,4150762,4150761,4150128,4150062,4149914,4146939,4146938,4117901,4117899,4117729,4117727,4117726,4116283,4116169,4116168,4116167,4116166,4116165,4116164,4115369,4115368,4115367,4115366,4104479,4103634,4103026,4102558,4102557,4102422,4102267,4101654,4101520,4101378,4100451,4100309,4083770,4079724,4063955,4034033,4004996,765422,765384,765271,765269,765249,765204,765109,763930,762297,762289,762288,761706,761705,761704,761703,761702,761652,761651,760921,760920,760919,760918,760915,760914,760897,760896,759910,759906,759905,759897,759896,79106,78517,78516,78508,78234,78232,77074,73231
)
insert into #dconcepts
select 'Malaise -Fatigue' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
45553741,45534458,45602032,1572255,45573032,45582718,1572256,1427711,1427710,1410843,44828146,44829293,44823445,44823473,42497014,45615297,45617037,3074311,3135073,3139188,3141968,3142026,3142369,3143883,3144202,3146371,3146507,3151402,3172766,3229948,3238838,3258651,3266617,3273005,3283667,3287817,3327058,3334534,3339745,3350143,3370653,3372110,3392605,3397636,3400957,3412804,3420248,3057687,3078650,3084756,3085115,3091284,3091286,3091287,3091289,3105428,3109609,3109620,3123043,3123251,45524713,45525703,45525341,45528375,45531370,45526417,45525339,45531372,45531374,45532419,45524714,45443858,45444906,45446529,45453869,45453870,45456613,45457249,45459954,45466756,45477423,45484078,45485120,45486787,45488447,45491729,45518337,45493396,45521607,45497290,45513348,45515012,45511614,45504959,45503934,45495007,45478465,45480798,45420273,45421796,45430052,45443238,40481844,437113,439926,765190,4059010,4060217,4074624,4086973,4093848,4147184,4149857,4152509,4158498,4161600,4167240,4198140,4223659,4272240,36686942,37017316,40267298,40303775,40303779,40303781,40303808,40322782,40325099,40325103,40325134,40348671,40351555,40351907,40354346,40390064,40391099,40417207,40448447,432738,40502727,40506944,40547299,44793521,44793522,44793523,3519112,3201572,3201296,3144125,3143844,3131465,3130861,3130858,3130857,3130856,3108483,3108253,3082266,3074305,40318810,40303776,4158183,44802677,4048774,4048773,4048772,4048775,44802674,44802673,44802672,44802421,44802417,44800199,44797749,40402990,40385132,40321411,40318814,40318812,40318811
)
insert into #dconcepts
select 'Headache' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
46270383,46270382,45766090,44790934,44783586,44782806,44782681,42539583,42538612,42538611,40483832,40482953,37110728,37016725,37016721,36716800,4315023,4309592,4271776,4212985,4195951,4193674,4183441,4172302,4170790,4170789,4158490,4149969,4147325,4140381,4115407,4103477,4061404,4044237,4038026,4038025,4037891,4037300,4036953,4036625,4036624,4036622,4030433,4028205,4012515,4012241,4012240,4012239,4011768,4011530,763746,762083,378253,377546,376104,374342,373463,372313
)
insert into #dconcepts
select 'Memorey Attention' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
45890915,45767114,45765900,45765899,45595932,45553736,45539344,44837454,44832709,44828985,44823476,44813139,44810571,44810569,44802689,44788981,44784643,44782727,44782726,44782725,44782432,42538566,42537141,42537139,40643427,40637025,40629685,40572565,40572164,40572158,40572112,40572107,40562773,40557775,40546686,40546678,40545778,40545771,40449573,40392746,40386916,40357200,40332778,40332775,40326369,40322273,40318822,40305057,40301718,40301716,40301713,37309663,37309662,37309661,37309660,37117145,37110498,37109222,37016192,36687122,35211349,35211348,35211347,35207397,4336523,4328349,4318665,4314615,4304008,4296610,4264770,4264146,4243064,4229448,4206332,4198081,4193675,4173661,4171718,4166262,4162498,4152488,4145069,4138824,4132117,4101994,4099961,4096717,4096147,4092086,4085655,4085043,4084562,4083456,4076655,4076654,4074319,4071219,4049065,4039106,4038788,4036509,4022572,4012209,4009705,4005009,1572241,761978,443432,439795,439147,437306
)
insert into #dconcepts
select 'Taste Smell' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
46270715,44782449,43530714,4291039,4286418,4282137,4266190,4238383,4229142,4224339,4222599,4187519,4168062,4145586,4049347,4049164,4043565,4029012,4008893
)
insert into #dconcepts
select 'Hair Loss' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
42539149,36716819,4300916,4253170,4175525,140173
)
insert into #dconcepts
select 'SOB Dyspnea' as concept_set, c1.concept_id, c1.concept_name
  --, cr.relationship_id, c2.concept_id, c2.concept_name, c2.concept_code, c2.vocabulary_id, c2.domain_id
from OMOP_Vocabulary.vocab_51.concept  c1
left join OMOP_Vocabulary.vocab_51.concept_relationship  cr on cr.concept_id_1 = c1.concept_id and cr.relationship_id = 'maps to'
left join OMOP_Vocabulary.vocab_51.concept c2 on c2.concept_id= cr.concept_id_2
where c2.concept_id in (
4191650,4221237,4222446,4222444,4223033,4223034,4223035,4223036,4220640,4223037,4223038,4220641,4219740,4059022,4059021,4190875,312437,4212233,4228754,4060052,4065915,4217021,4219335,4248284,4066850,4263848,4091788,35610139,35610140,35610141,35610143,35610142,35610144,4144682,4047610,4178416,4097311,4310059,4193263,4307188,4310172,4192279,44809070,36685567,36685568,36685569,36685570,36685571,4094132,4060439,4060709,315361,4244276,4206307,4148800,4308377,4010972,4253185
)

--select * from #dconcepts;
/*************************************************************************************************************  
Section 3
Query: 
*************************************************************************************************************/

	-- Create full set of permissible concepts  (gender, race, ethnicity, age-range)
	if object_id('tempdb.dbo.#gender') is not null drop table #gender  
	select concept_id covariate_id, domain_id covariate_name, concept_name covariate_value 
	into #gender from OMOP_Vocabulary.vocab_51.concept 
	where domain_id = 'Gender' and standard_concept = 'S' 
	union 
	select 0, 'Gender', 'Unknown' 

	if object_id('tempdb.dbo.#race') is not null drop table #race  
	select concept_id covariate_id, domain_id covariate_name, concept_name covariate_value , concept_code
	into #race from OMOP_Vocabulary.vocab_51.concept 
	where domain_id = 'race' --and standard_concept = 'S' 
	and concept_code  in ('1','2','3','4','5','9','UNK')
	
	if object_id('tempdb.dbo.#ethnicity') is not null drop table #ethnicity  
	select concept_id covariate_id, domain_id covariate_name, concept_name covariate_value  
	into #ethnicity from OMOP_Vocabulary.vocab_51.concept 
	where domain_id = 'ethnicity' and standard_concept = 'S' 
	union 
	select 0, 'Ethnicity', 'Unknown' 

	if object_id('tempdb.dbo.#age_range') is not null drop table #age_range  
	select 1 covariate_id, 'Age_Range' covariate_name, '[18 - 30]' covariate_value into #age_range  union 
	select 2, 'Age_Range', '[31 - 40]' union 
	select 3, 'Age_Range', '[41 - 50]' union 
	select 4, 'Age_Range', '[51 - 60]' union 
	select 5, 'Age_Range', '[61 - 70]' union 
	select 6, 'Age_Range', '[71 - 80]' union 
	select 7, 'Age_Range', '[81 - ]' union
	select 8, 'Age_Range', 'Unknown' 

	-----------------------------------------------------------------------------------------------
	

	drop table if exists #apatients;
	-- have diagnosis codes between 2020 and 2021
	select * into #apatients from (
	(
	select distinct c.person_id, dc.concept_set, c.condition_concept_id,
	case when dc.concept_set is null then 0 else 1 end as outcome
	from #covid_positive cp  
	join omop5.condition_occurrence c on c.person_id=cp.PERSON_ID 
	join #dconcepts dc on c.condition_concept_id=dc.concept_id
	and c.condition_start_date between DATEADD(DAY,21,CONVERT(date, cp.COHORT_START_DATE)) -- KP CHANGED 14 to 21 04/08/2021
	and DATEADD(DAY, 180, CONVERT(date, cp.COHORT_START_DATE)) -- KP added line 04/08/2021
	--and @cohortEndDate  --'2021-03-15' -- KP commented out line 04/08/2021

	except (
	-- have diagnosis codes between 2018 and 2019
	
	select distinct c.person_id, dc.concept_set, c.condition_concept_id,
	case when dc.concept_set is null then 0 else 1 end as outcome
	from #covid_positive cp 
	join omop5.condition_occurrence c  on c.person_id=cp.PERSON_ID 
	join #dconcepts dc on c.condition_concept_id=dc.concept_id
	and c.condition_start_date between DATEADD(DAY,-365,CONVERT(date, cp.COHORT_START_DATE)) 
	and DATEADD(DAY,-30,CONVERT(date, cp.COHORT_START_DATE))
))) x;



-- Any PASC condition 
insert into #apatients (person_id, concept_set, condition_concept_id, outcome)
select person_id, 'Any PASC condition' concept_set, 0 condition_concept_id, max(outcome) outcome
from #apatients 
group by person_id
 


drop table if exists #fpatients;
select distinct cp.person_id, concept_set, cp.AgeAt_PCR_test
into #fpatients from 
#covid_positive cp 
cross join (
	select distinct concept_set from #dconcepts
	union
	select 'Any PASC condition'	
	) cpc

drop table if exists #dpatients;
select fp.person_id, fp.concept_set,
case when fp.concept_set in (select dp.concept_set from #apatients dp where dp.person_id=fp.person_id) then 1 else 0 end as Outcome_value
, fp.AgeAt_PCR_test
into #dpatients
from #fpatients fp

	-----------------------------------------------------------------------------------------------

	if object_id('tempdb.dbo.#patients') is  not null drop table #patients 
	select distinct hsp1.visit_occurrence_id, vo.person_id, hsp1.visit_concept_id, hsp1.visit_start_datetime, hsp1.visit_end_datetime
	, hsp1.Hospital_mortality
	, case when hsp1.visit_occurrence_id is null then 0 else 1 end Exposure_variable_id
	, case when gender.covariate_id is null then 0 else p.gender_concept_id end gender_concept_id 
	,p.race_concept_id person_race_concept_id, p.race_source_value, race.concept_code
	, case when race.concept_code = '1' or race.concept_code like '1.%' then 8657			-- American Indian or Alaska Native
		  when race.concept_code = '2' or race.concept_code like '2.%' then 8515			-- Asian
		  when race.concept_code = '3' or race.concept_code like '3.%' then 8516			-- Black or African American
		  when race.concept_code = '4' or race.concept_code like '4.%' then 8557			-- Native Hawaiian or Other Pacific Islander
		  when race.concept_code = '5' or race.concept_code like '5.%' then 8527			-- White
		  when race.concept_code = '9' or race.covariate_id in (44814649, 44814659) then 8522	-- Other Race
		  else 8552																			-- Unknown
	 end as race_concept_id 
	, case when ethnicity.covariate_id is null then 0 else p.ethnicity_concept_id end ethnicity_concept_id 
	, case when round(vo.AgeAt_PCR_test ,2) between 18 and 30 then 1
		when round(vo.AgeAt_PCR_test ,2) between 31 and 40 then 2
		when round(vo.AgeAt_PCR_test ,2) between 41 and 50 then 3
		when round(vo.AgeAt_PCR_test ,2) between 51 and 60 then 4
		when round(vo.AgeAt_PCR_test ,2) between 61 and 70 then 5
		when round(vo.AgeAt_PCR_test ,2) between 71 and 80 then 6
		when round(vo.AgeAt_PCR_test ,2) > 80 then 7
	else 8 end as age_id,
	vo.concept_set
	,vo.Outcome_value
	into #patients
	from #dpatients vo left join #covid_hsp hsp1 on vo.person_id= hsp1.person_id
	
	left join omop5.person p on p.person_id = vo.person_id

	left join #gender gender on gender.covariate_id = p.gender_concept_id
	left join #race race on race.covariate_id = p.race_concept_id
	left join #ethnicity ethnicity on ethnicity.covariate_id = p.ethnicity_concept_id
	
	--select * from #patients;

/**************************************************************************************************
Section 4:			Results
**************************************************************************************************/


--Section A: Results setup
	if object_id('tempdb.dbo.#Exposure_variable') is not null drop table #Exposure_variable
	select 0 Exposure_variable_id, 'Hospitalized' Exposure_variable_name , 'No' Exposure_variable_value 
	into #Exposure_variable
	union
	select 1, 'Hospitalized', 'Yes';
	
	if object_id('tempdb.dbo.#Outcome') is not null drop table #Outcome  
	select 1 Outcome_id, 'Myocarditis Pericarditis' Outcome_name, 'Yes' Outcome_value 
	into #Outcome 
	union
	select 1 Outcome_id, 'Insomnia' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Dizziness Vertigo' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Fever' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Myositis Mylgia' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Mental Health' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Cough' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Nausa Vomiting Diarrhea' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Arthalgias' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Malaise -Fatigue' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Headache' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Memorey Attention' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Taste Smell' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Hair Loss' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'SOB Dyspnea' Outcome_name, 'Yes' Outcome_value 
	union
	select 1 Outcome_id, 'Any PASC condition' Outcome_name, 'Yes' Outcome_value 

	union
	select 0 Outcome_id, 'Myocarditis Pericarditis' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Insomnia' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Dizziness Vertigo' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Fever' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Myositis Mylgia' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Mental Health' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Cough' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Nausa Vomiting Diarrhea' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Arthalgias' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Malaise -Fatigue' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Headache' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Memorey Attention' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Taste Smell' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Hair Loss' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'SOB Dyspnea' Outcome_name, 'No' Outcome_value 
	union
	select 0 Outcome_id, 'Any PASC condition' Outcome_name, 'No' Outcome_value 
---------------------------------------------------------------------
--------------------------------------------------------------------


--Section B: Results
	if object_id('tempdb.dbo.#results') is not null drop table #results
	--Gender
	select @sitename Institution
	, m.covariate_name 
	, m.covariate_value 
	, m.Exposure_variable_name
	, m.Exposure_variable_value 
	, m.Outcome_name
	, m.Outcome_value
	, count(distinct person_id) PatientCount
	, @version Query_Version
	, @queryExecutionDate Query_Execution_Date
	into #results
	from (select * from  #gender
			cross join  #Exposure_variable
			cross join #outcome
		) m 
	left join #patients p on m.Exposure_variable_id = p.Exposure_variable_id
		and m.covariate_id = p.gender_concept_id and m.Outcome_name=p.concept_set and m.Outcome_id=p.Outcome_value
	group by m.covariate_name, m.covariate_value, m.Exposure_variable_name, m.Exposure_variable_value, m.Outcome_name, m.Outcome_value

	union 

	--race
	select @sitename Institution
	, m.covariate_name 
	, m.covariate_value 
	, m.Exposure_variable_name
	, m.Exposure_variable_value 
		,m.Outcome_name
	, m.Outcome_value
	, count(distinct person_id) PatientCount
	, @version Query_Version
	, @queryExecutionDate Query_Execution_Date
	from (select * from  #race
			cross join  #Exposure_variable
			cross join #outcome
		) m 
	left join #patients p on m.Exposure_variable_id = p.Exposure_variable_id
		and m.covariate_id = p.race_concept_id and m.Outcome_name=p.concept_set and m.Outcome_id=p.Outcome_value
	group by m.covariate_name, m.covariate_value, m.Exposure_variable_name, m.Exposure_variable_value, m.Outcome_name, m.Outcome_value
	
	union 

	--ethnicity
	select @sitename Institution
	, m.covariate_name 
	, m.covariate_value 
	, m.Exposure_variable_name
	, m.Exposure_variable_value 
	, m.Outcome_name
	, m.Outcome_value
	, count(distinct person_id) PatientCount
	, @version Query_Version
	, @queryExecutionDate Query_Execution_Date
	from (select * from  #ethnicity
			cross join  #Exposure_variable
			cross join #outcome
		) m 
	left join #patients p on m.Exposure_variable_id = p.Exposure_variable_id
		and m.covariate_id = p.ethnicity_concept_id and m.Outcome_name=p.concept_set and m.Outcome_id=p.Outcome_value
	group by m.covariate_name, m.covariate_value, m.Exposure_variable_name, m.Exposure_variable_value, m.Outcome_name, m.Outcome_value

	
	union 

	--age range
	select @sitename Institution
	, m.covariate_name 
	, m.covariate_value 
	, m.Exposure_variable_name
	, m.Exposure_variable_value 
	, m.Outcome_name
	, m.Outcome_value
	, count(distinct person_id) PatientCount
	, @version Query_Version
	, @queryExecutionDate Query_Execution_Date
	from (select * from  #age_range
			cross join  #Exposure_variable
			cross join #outcome
		) m 
	left join #patients p on m.Exposure_variable_id = p.Exposure_variable_id
		and m.covariate_id = p.age_id and m.Outcome_name=p.concept_set and m.Outcome_id=p.Outcome_value
	group by m.covariate_name, m.covariate_value, m.Exposure_variable_name, m.Exposure_variable_value, m.Outcome_name, m.Outcome_value

	union 

	-- counts w/o demographic breakdown
	select @sitename Institution
	, 'none' covariate_name 
	, 'none' covariate_value 
	, m.Exposure_variable_name
	, m.Exposure_variable_value 
	, m.Outcome_name
	, m.Outcome_value
	, count(distinct person_id) PatientCount
	, @version Query_Version
	, @queryExecutionDate Query_Execution_Date
	from (select * from #Exposure_variable
			cross join #outcome
		) m 
	left join #patients p on m.Exposure_variable_id = p.Exposure_variable_id
		and  m.Outcome_name=p.concept_set and m.Outcome_id=p.Outcome_value
	group by  m.Exposure_variable_name, m.Exposure_variable_value, m.outcome_name, m.outcome_value
	

	order by Exposure_variable_name, covariate_name, covariate_value, Exposure_variable_value, m.Outcome_name, m.Outcome_value



	--- Mask cell counts 
	drop table if exists #temp1;
	select Institution, covariate_name, covariate_value, Exposure_variable_name, Exposure_variable_value, Outcome_name, Outcome_value
	, case when @minAllowedCellCount = 0 then try_convert(varchar(20), PatientCount)
			when @minAllowedCellCount = 11 and PatientCount between 1 and 10 then '[1-10]' 
			when @minAllowedCellCount = 11 and PatientCount = 0 or PatientCount >=11 then  try_convert(varchar(20), PatientCount)			
			end as PatientCount
	, Query_Version
	, Query_Execution_Date
	from #results 
	order by covariate_name, covariate_value, Exposure_variable_name, Exposure_variable_value, Outcome_name, Outcome_value